---
description:
globs:
alwaysApply: true
---
# Cluster Upgrade and System Extension Guide for This Repository

This guide outlines how to upgrade Talos OS, Kubernetes, and manage Talos system extensions specifically for this project, leveraging its configuration files and `[Taskfile.yaml](mdc:Taskfile.yaml)` automation.

## 1. Understanding Key Configuration Files

- **`[talenv.yaml](mdc:talos/talenv.yaml)`**: Defines the target `talosVersion` and `kubernetesVersion` for the cluster. This file is the source of truth for version upgrades.
- **`[talconfig.yaml](mdc:talos/talconfig.yaml)`**: Contains the detailed Talos cluster configuration, including node definitions and the `talosImageURL` for each node. The `talosImageURL` (e.g., `factory.talos.dev/installer/<SCHEMATIC_ID>`) embeds the chosen Talos version and any pre-selected system extensions based on a schematic ID from the [Talos Linux Image Factory](mdc:https:/factory.talos.dev).
- **`[README.md](mdc:README.md)`**: Provides general project setup, workflow, and includes crucial `task` commands for cluster operations.
- **`[hardware-configuration.mdc](mdc:hardware-configuration.mdc)`**: Details the specific hardware setup, including node IPs (e.g., 192.168.1.98 for k8s-1) and names (k8s-1, k8s-2, k8s-3), which are used in `task` commands. It also notes the Talos schematic ID currently in use.

## 2. Upgrading Talos OS Version

The Talos OS version for the cluster is managed via `[talenv.yaml](mdc:talos/talenv.yaml)` and applied using a task.

**Procedure:**

1.  **Update Target Version:**
    Modify the `talosVersion` in `[talenv.yaml](mdc:talos/talenv.yaml)` to the desired new version. For example:
    ```yaml
    # talos/talenv.yaml
    talosVersion: v1.10.0 # Changed from a previous version
    kubernetesVersion: v1.32.0 # Or your current/target k8s version
    ```
2.  **(Re)generate Talos Configuration:**
    Ensure configurations are up-to-date with the new version, especially if other related settings in `[talconfig.yaml](mdc:talos/talconfig.yaml)` might be affected or if you've changed the schematic ID (see section 4).
    ```bash
    task configure
    ```
3.  **Upgrade Each Node:**
    Execute the upgrade task for each node in your cluster, one at a time. Refer to `[hardware-configuration.mdc](mdc:hardware-configuration.mdc)` for node IPs.
    ```bash
    task talos:upgrade-node IP=<NODE_IP>
    # Example for k8s-1 (IP: 192.168.1.98 from hardware-configuration.mdc)
    # task talos:upgrade-node IP=192.168.1.98
    ```
    Follow this for all nodes (k8s-1, k8s-2, k8s-3).
    The `[README.md](mdc:README.md)` section "Updating Talos and Kubernetes versions" details this.

## 3. Upgrading Kubernetes Version

The Kubernetes version for the cluster is also managed via `[talenv.yaml](mdc:talos/talenv.yaml)` and applied using a task.

**Procedure:**

1.  **Update Target Version:**
    Modify the `kubernetesVersion` in `[talenv.yaml](mdc:talos/talenv.yaml)` to the desired new version.
    ```yaml
    # talos/talenv.yaml
    talosVersion: v1.10.0 # Or your current/target Talos version
    kubernetesVersion: v1.33.0 # Changed from a previous version
    ```
2.  **(Re)generate Talos Configuration:**
    Ensure your Talos configurations reflect the new Kubernetes version.
    ```bash
    task configure
    ```
3.  **Upgrade Kubernetes on the Cluster:**
    Execute the Kubernetes upgrade task. This typically orchestrates the upgrade across the control plane.
    ```bash
    task talos:upgrade-k8s
    ```
    The `[README.md](mdc:README.md)` section "Updating Talos and Kubernetes versions" details this.

## 4. Managing Talos System Extensions

Talos system extensions (e.g., drivers, custom runtimes) are baked into the Talos installer image specified by the `talosImageURL` in `[talconfig.yaml](mdc:talos/talconfig.yaml)`. This URL includes a **schematic ID** obtained from the [Talos Linux Image Factory](mdc:https:/factory.talos.dev). The schematic ID noted in `[hardware-configuration.mdc](mdc:hardware-configuration.mdc)` and present in `[talconfig.yaml](mdc:talos/talconfig.yaml)` is `064d2c892ac9a3a7da7fa550dbdd1516908bd9dfe355ad345ff4e9d8f8b34930`.

**Procedure to Change/Add/Remove Extensions:**

1.  **Visit Talos Image Factory:**
    Go to the [Talos Linux Image Factory](mdc:https:/factory.talos.dev).
2.  **Select Talos Version and Extensions:**
    Choose the Talos OS version (ideally matching or planned for your `talosVersion` in `[talenv.yaml](mdc:talos/talenv.yaml)`) and select/deselect the desired system extensions.
    As per `[README.md](mdc:README.md)` Stage 1: "Be sure to only choose the **bare-minimum system extensions** as some might require additional configuration and prevent Talos from booting without it. You can always add system extensions after Talos is installed and working."
3.  **Obtain New Schematic ID:**
    After configuring, the factory will provide a new schematic ID.
4.  **Update `[talconfig.yaml](mdc:talos/talconfig.yaml)`:**
    For each node under the `nodes:` section, update the `talosImageURL` by replacing the old schematic ID with the new one.
    Example for `k8s-1`:
    ```yaml
    # talos/talconfig.yaml
    nodes:
      - hostname: "k8s-1"
        # ... other settings ...
        talosImageURL: factory.talos.dev/installer/<NEW_SCHEMATIC_ID> # Replace old schematic ID
        # ...
    ```
    Repeat for all nodes (k8s-1, k8s-2, k8s-3).
5.  **(Re)generate Talos Configuration:**
    This step is crucial to ensure the machine configurations reflect the new installer image.
    ```bash
    task configure
    ```
6.  **Apply Updated Configuration to Nodes:**
    Apply the newly generated configuration to each node.
    ```bash
    task talos:apply-node IP=<NODE_IP> MODE=auto
    # Example for k8s-1
    # task talos:apply-node IP=192.168.1.98 MODE=auto
    ```
7.  **Upgrade Nodes (If Necessary):**
    As mentioned in the `[README.md](mdc:README.md)` under "Updating Talos node configuration": "In some cases you **not only need to apply the configuration but also upgrade talos** to apply new configuration."
    If changing extensions involves what Talos considers an OS-level change (which is likely if the installer image itself changes), or if you are also changing the `talosVersion`, you will likely need to run the upgrade task for each node:
    ```bash
    task talos:upgrade-node IP=<NODE_IP>
    ```
    This will make the node reboot and use the new installer image with the updated extensions.

## Important Considerations

- **Sequential Operations:** Always upgrade/apply configurations to one node at a time, especially for control plane nodes, to maintain cluster stability.
- **Backup `[age.key](mdc:age.key)`**: While not directly related to upgrades, remember `[sops](mdc:.sops.yaml)` is used for secrets. Ensure your `age.key` (referenced as `[age.key](mdc:age.key)`) is securely backed up.
- **Read Release Notes:** Before any Talos or Kubernetes upgrade, consult the official release notes for breaking changes or specific instructions.
- **Git Commits:** Commit changes to `[talenv.yaml](mdc:talos/talenv.yaml)`, `[talconfig.yaml](mdc:talos/talconfig.yaml)`, and any generated files to your Git repository to maintain the GitOps workflow.
