---
apiVersion: batch/v1
kind: Job
metadata:
  name: velero-credential-generator
  namespace: storage
spec:
  template:
    spec:
      serviceAccountName: default
      restartPolicy: OnFailure
      containers:
      - name: generate-credentials
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          # Get credentials from Ceph secret
          ACCESS_KEY=$(echo $CEPH_ACCESS_KEY | base64 -d)
          SECRET_KEY=$(echo $CEPH_SECRET_KEY | base64 -d)
          
          # Create AWS credentials format
          cat > /tmp/cloud <<EOF
          [default]
          aws_access_key_id = ${ACCESS_KEY}
          aws_secret_access_key = ${SECRET_KEY}
          EOF
          
          # Create the secret
          kubectl create secret generic velero-credentials \
            --from-file=cloud=/tmp/cloud \
            --namespace=storage \
            --dry-run=client -o yaml | kubectl apply -f -
        env:
        - name: CEPH_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: rook-ceph-object-user-storage-velero
              key: AccessKey
        - name: CEPH_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: rook-ceph-object-user-storage-velero
              key: SecretKey