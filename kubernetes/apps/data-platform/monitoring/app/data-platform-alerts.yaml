---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: data-platform-performance
  namespace: data-platform
  labels:
    app.kubernetes.io/name: data-platform-performance
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: data-platform
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  # Note: Removed Trino, Spark, Nessie, and Iceberg alerts as these services
  # have been decommissioned from the cluster. Alerts for non-existent
  # metrics cause PrometheusRule validation failures.

  - name: data-platform.storage
    interval: 60s
    rules:
    - alert: S3BucketUsageHigh
      expr: s3_bucket_size_bytes{bucket=~"iceberg-.*"} / s3_bucket_quota_bytes > 0.8
      for: 5m
      labels:
        severity: warning
        component: s3
      annotations:
        summary: "S3 bucket usage is high"
        description: "Bucket {{ $labels.bucket }} is {{ $value | humanizePercentage }} full"
        
    - alert: S3ConnectionErrors
      expr: rate(s3_request_errors_total[5m]) > 0.05
      for: 5m
      labels:
        severity: warning
        component: s3
      annotations:
        summary: "High S3 connection error rate"
        description: "S3 error rate is {{ $value }} errors/sec over the last 5 minutes"

  - name: data-platform.resources
    interval: 30s
    rules:
    - alert: DataPlatformPodCrashLoop
      expr: rate(kube_pod_container_status_restarts_total{namespace="data-platform"}[5m]) > 0
      for: 2m
      labels:
        severity: warning
        component: kubernetes
      annotations:
        summary: "Pod in data-platform namespace is crash looping"
        description: "Pod {{ $labels.pod }} is restarting frequently"
        
    - alert: DataPlatformPodMemoryThrottling
      expr: rate(container_memory_failures_total{namespace="data-platform"}[5m]) > 0
      for: 2m
      labels:
        severity: warning
        component: kubernetes
      annotations:
        summary: "Memory throttling detected in data-platform"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is experiencing memory pressure"
        
    - alert: DataPlatformNamespaceResourceExhaustion
      expr: |
        (
          sum(kube_resourcequota{namespace="data-platform", resource="requests.memory", type="used"}) /
          sum(kube_resourcequota{namespace="data-platform", resource="requests.memory", type="hard"})
        ) > 0.9
      for: 5m
      labels:
        severity: critical
        component: kubernetes
      annotations:
        summary: "Data platform namespace approaching resource limits"
        description: "Namespace data-platform is using {{ $value | humanizePercentage }} of allocated memory quota"