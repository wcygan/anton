---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: harbor-postgres
spec:
  # WHY: 3 instances provides HA with automatic failover
  # Primary + 2 replicas ensures no data loss on node failure
  instances: 3

  imageName: ghcr.io/cloudnative-pg/postgresql:17.2

  # WHY: Separate storage for PostgreSQL WAL improves performance
  # by allowing parallel I/O for data and transaction logs
  storage:
    storageClass: ceph-block
    size: 20Gi

  walStorage:
    storageClass: ceph-block
    size: 5Gi

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      memory: 1Gi

  postgresql:
    parameters:
      # WHY: Tuned for Harbor's metadata-heavy workload
      shared_buffers: "256MB"
      effective_cache_size: "512MB"
      maintenance_work_mem: "64MB"
      max_connections: "100"

  bootstrap:
    initdb:
      database: registry
      owner: harbor
      # WHY: Harbor requires specific databases for its components
      postInitSQL:
        - CREATE DATABASE notaryserver OWNER harbor;
        - CREATE DATABASE notarysigner OWNER harbor;

  monitoring:
    enablePodMonitor: true
