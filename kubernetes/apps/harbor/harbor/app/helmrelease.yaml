---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: harbor
spec:
  chart:
    spec:
      chart: harbor
      version: 1.16.2
      sourceRef:
        kind: HelmRepository
        name: harbor
  interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  valuesFrom:
    # WHY: Pull admin password from SOPS-encrypted secret
    - kind: Secret
      name: harbor-admin-secret
      valuesKey: adminPassword
      targetPath: harborAdminPassword
    # WHY: CNPG auto-generates credentials in harbor-postgres-app secret
    - kind: Secret
      name: harbor-postgres-app
      valuesKey: password
      targetPath: database.external.password
  values:
    # WHY: LoadBalancer with Cilium LB IPAM gives Harbor a stable LAN IP (192.168.1.105).
    # This makes the externalURL reachable from both containerd (host network) and pods,
    # fixing Docker auth realm redirects that failed with Tailscale-only access.
    expose:
      type: loadBalancer
      tls:
        enabled: false
      loadBalancer:
        name: harbor
        ports:
          httpPort: 80
          httpsPort: 443
        annotations:
          lbipam.cilium.io/ips: "192.168.1.105"

    # WHY: externalURL controls the Docker token auth realm in WWW-Authenticate headers.
    # Using the LoadBalancer IP ensures containerd on Talos nodes can complete auth flow.
    externalURL: http://192.168.1.105

    # WHY: Internal TLS disabled â€” primary access is HTTP via LoadBalancer (192.168.1.105).
    # Tailscale Ingress handles TLS only for the remote web UI.
    internalTLS:
      enabled: false

    persistence:
      enabled: true
      resourcePolicy: keep
      persistentVolumeClaim:
        registry:
          # WHY: ceph-filesystem with RWX needed for multi-replica registry
          storageClass: ceph-filesystem
          accessMode: ReadWriteMany
          size: 100Gi
        jobservice:
          jobLog:
            # WHY: ceph-filesystem with RWX needed for multi-replica jobservice
            storageClass: ceph-filesystem
            accessMode: ReadWriteMany
            size: 1Gi
        trivy:
          storageClass: ceph-block
          size: 5Gi

    # WHY: 2 replicas for core components enables HA
    # without excessive resource consumption
    portal:
      replicas: 2
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          memory: 256Mi

    core:
      replicas: 2
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi

    jobservice:
      replicas: 2
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 256Mi

    registry:
      replicas: 2
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi

    trivy:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          memory: 1Gi

    # WHY: Disable internal database - use CNPG HA cluster instead
    database:
      type: external
      external:
        host: harbor-postgres-rw.harbor.svc.cluster.local
        port: "5432"
        username: harbor
        coreDatabase: registry
        sslmode: require

    # WHY: Disable internal Redis - use DragonflyDB HA cluster instead
    redis:
      type: external
      external:
        addr: harbor-redis.harbor.svc.cluster.local:6379
        coreDatabaseIndex: "0"
        jobserviceDatabaseIndex: "1"
        registryDatabaseIndex: "2"
        trivyAdapterIndex: "5"

    # WHY: Prometheus metrics for observability
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

    # WHY: Log to stdout for collection by cluster logging stack
    log:
      level: info

    # WHY: Disable components not needed for basic registry functionality
    notary:
      enabled: false

    cache:
      enabled: true
      expireHours: 24
