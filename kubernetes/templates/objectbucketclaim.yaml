---
# ObjectBucketClaim template for automated S3 bucket provisioning
# This template creates an S3-compatible bucket with automatic credential generation
apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: ${APP_NAME}-bucket
  namespace: ${NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/component: storage
spec:
  # Name to use for the bucket (optional - auto-generated if not specified)
  # bucketName: ${BUCKET_NAME}
  
  # Storage class that handles bucket provisioning
  storageClassName: ceph-bucket
  
  # Additional configuration - ONLY simple string key-value pairs supported
  # Complex configs like lifecycle rules, policies, CORS must be applied via Ceph tools
  additionalConfig:
    # Basic storage limits (all values must be strings)
    maxObjects: "100000"   # Maximum number of objects allowed
    maxSize: "50Gi"        # Maximum storage size for bucket
    
    # NOTE: The following are NOT supported in additionalConfig:
    # - lifecycleConfiguration (use Ceph lifecycle policies)
    # - bucketPolicy (use Ceph bucket policies)
    # - corsConfiguration (use Ceph CORS config)
    # - Any complex YAML/JSON structures
---
# Example usage with External Secrets Operator for credential sync
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ${APP_NAME}-bucket-sync
  namespace: ${NAMESPACE}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: ${APP_NAME}-bucket-credentials
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Map the auto-generated credentials to a format your app expects
        AWS_ACCESS_KEY_ID: "{{ .AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ .AWS_SECRET_ACCESS_KEY }}"
        BUCKET_NAME: "{{ .BUCKET_NAME }}"
        BUCKET_HOST: "{{ .BUCKET_HOST }}"
        BUCKET_PORT: "{{ .BUCKET_PORT }}"
        BUCKET_ENDPOINT: "http://{{ .BUCKET_HOST }}:{{ .BUCKET_PORT }}"
  dataFrom:
    - extract:
        # Reference the OBC-generated secret
        key: ${APP_NAME}-bucket-credentials
        # This will be populated after we implement the sync automation